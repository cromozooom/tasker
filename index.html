<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>âœ… Tasker</title>
    <link href="./src/output.css" rel="stylesheet" />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div x-data="taskViewer()">
      <template x-if="error">
        <p x-text="error" style="color: red"></p>
      </template>
      <template x-if="!error && !loaded">
        <p>Loading tasks...</p>
      </template>

      <template x-if="loaded">
        <div>
          <div class="flex justify-between items-center p-2">
            <h1 class="text-xl font-bold">Tasker</h1>
            <button
              @click="downloadTasks()"
              class="p-3 border bg-blue-600 text-white rounded-md"
            >
              Export Tasks
            </button>
          </div>
          <template
            x-for="(section, sectionIndex) in sections"
            :key="sectionIndex"
          >
            <template x-if="section.tasks.length">
              <div class="p-3">
                <div class="flex pb-5">
                  <h2 x-text="section.title" class="font-bold text-xl"></h2>
                </div>
                <!-- <div x-html="renderMarkdown(section.content)"></div> -->
                <template
                  x-for="(task, taskIndex) in section.tasks"
                  :key="sectionIndex + '-' + taskIndex"
                >
                  <div
                    :class="'task priority-' + task.priority"
                    class="flex flex-col border-b m-3 py-2"
                  >
                    <div class="flex items-start pb-2">
                      <div>
                        <span
                          :class="taskClass(task.priority)"
                          class="text-white aspect-square w-6 flex justify-center items-center border rounded-full p-1 text-center mr-2"
                          x-text="task.priority"
                        ></span>
                      </div>
                      <div class="pt-1">
                        <div x-html="renderMarkdown(task.content)"></div>
                      </div>
                    </div>
                    <label
                      ><strong>Status:</strong>
                      <select
                        x-model="task.status"
                        @change="saveToLocalStorage()"
                      >
                        <option value="">Select status</option>
                        <option value="Not Started">Not Started</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                      </select>
                    </label>

                    <label><strong>Notes:</strong></label>
                    <!-- <div x-html="renderMarkdown(task.notes)"></div> -->
                    <textarea
                      x-model="task.notes"
                      :id="'editor-' + sectionIndex + '-' + taskIndex"
                      x-ref="'editor-' + sectionIndex + '-' + taskIndex"
                      @click="initializeEditor($event, sectionIndex, taskIndex)"
                    ></textarea>
                  </div>
                </template>
              </div>
            </template>
          </template>
        </div>
      </template>
    </div>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css"
    />
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

    <script>
      function taskViewer() {
        return {
          sections: [],
          loaded: false,
          error: "",
          activeEditor: null,
          init() {
            console.log("Fetching tasks...");
            const storedData = localStorage.getItem("tasks");
            if (storedData) {
              this.sections = JSON.parse(storedData);
              this.loaded = true;
            } else {
              fetch("tasks.json")
                .then((response) => {
                  if (!response.ok) {
                    throw new Error(
                      "Network response was not ok: " + response.statusText
                    );
                  }
                  return response.json();
                })
                .then((data) => {
                  this.sections = data;
                  this.saveToLocalStorage();
                  this.loaded = true;
                })
                .catch((error) => {
                  console.error("Failed to load tasks:", error);
                  this.error = "Failed to load tasks: " + error.message;
                });
            }

            // Register a global click event listener
            document.addEventListener(
              "click",
              this.handleClickOutside.bind(this)
            );
          },
          saveToLocalStorage() {
            localStorage.setItem("tasks", JSON.stringify(this.sections));
          },
          renderMarkdown(content) {
            return marked.parse(content);
          },

          initializeEditor(event, sectionIndex, taskIndex) {
            const element = event.target;
            const task = this.sections[sectionIndex].tasks[taskIndex];
            console.log("Task:", task);

            // Check if the editor is already initialized
            if (!element.simplemde) {
              const simplemde = new SimpleMDE({ element });
              element.simplemde = simplemde; // Store the editor instance in the element
              simplemde.value(task.notes);
              simplemde.codemirror.on("change", () => {
                task.notes = simplemde.value();
                this.saveToLocalStorage();
              });
            }
            this.activeEditor = element;
          },

          handleClickOutside(event) {
            console.log(event);
            console.log(this.activeEditor);
            // Check if the click target is outside the active editor
            if (
              this.activeEditor &&
              !this.activeEditor.contains(event.target)
            ) {
              this.destroyEditor(this.activeEditor);
              this.activeEditor = null;
            }
          },
          destroyEditor(element) {
            if (element && element.simplemde) {
              console.log("Destroying editor");
              element.simplemde.toTextArea();
              element.simplemde = null;
            }
          },

          downloadTasks() {
            const dataStr = JSON.stringify(this.sections, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "tasks.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          },
          taskClass(priority) {
            switch (priority) {
              case 0:
                return "bg-red-500";
              case 1:
                return "bg-orange-500";
              case 2:
                return "bg-yellow-500";
              case 3:
                return "bg-green-500";
              case 4:
                return "bg-blue-500";
              case 5:
                return "bg-gray-500";
              default:
                return "bg-gray-500";
            }
          },
        };
      }
    </script>
  </body>
</html>
