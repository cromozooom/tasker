<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>âœ… Tasker</title>
    <link href="./src/output.css" rel="stylesheet" />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body x-data="{ darkMode: false }" class="bg-white dark:bg-gray-950">
    <div x-data="taskViewer()">
      <template x-if="error">
        <p x-text="error" style="color: red"></p>
      </template>
      <template x-if="!error && !loaded">
        <p>Loading tasks...</p>
      </template>

      <template x-if="loaded">
        <div>
          <div class="flex justify-between items-center p-2">
            <h1 class="text-xl font-bold">Tasker</h1>

            <div class="flex">
              <button
                type="button"
                class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800"
                @click="downloadTasks()"
              >
                Export Tasks
              </button>
              <button
                type="button"
                class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800"
                x-data="{ darkMode: false }"
                x-init="initDarkMode()"
                @click="toggleDarkMode()"
              >
                Switch theme
              </button>
            </div>
          </div>
          <div class="mb-4">
            <div class="mb-2">
              <strong>Filter by Status:</strong>
              <button
                @click="filterStatus = ''; filterTasks();"
                :class="{'active-filter': filterStatus === ''}"
                class="p-3 border rounded"
              >
                All
              </button>
              <button
                @click="filterStatus = 'Not Started'; filterTasks();"
                :class="{'active-filter': filterStatus === 'Not Started'}"
                class="p-3 border rounded"
              >
                Not Started
              </button>
              <button
                @click="filterStatus = 'In Progress'; filterTasks();"
                :class="{'active-filter': filterStatus === 'In Progress'}"
                class="p-3 border rounded"
              >
                In Progress
              </button>
              <button
                @click="filterStatus = 'Completed'; filterTasks();"
                :class="{'active-filter': filterStatus === 'Completed'}"
                class="p-3 border rounded"
              >
                Completed
              </button>
            </div>
            <div>
              <strong>Filter by Priority:</strong>
              <button
                @click="filterPriority = ''; filterTasks();"
                :class="{'active-filter': filterPriority === ''}"
                class="p-3 border rounded"
              >
                All
              </button>
              <button
                @click="filterPriority = 0; filterTasks();"
                :class="{'active-filter': filterPriority === 0}"
                class="p-3 border rounded"
              >
                0
              </button>
              <button
                @click="filterPriority = 1; filterTasks();"
                :class="{'active-filter': filterPriority === 1}"
                class="p-3 border rounded"
              >
                1
              </button>
              <button
                @click="filterPriority = 2; filterTasks();"
                :class="{'active-filter': filterPriority === 2}"
                class="p-3 border rounded"
              >
                2
              </button>
              <button
                @click="filterPriority = 3; filterTasks();"
                :class="{'active-filter': filterPriority === 3}"
                class="p-3 border rounded"
              >
                3
              </button>
              <button
                @click="filterPriority = 4; filterTasks();"
                :class="{'active-filter': filterPriority === 4}"
                class="p-3 border rounded"
              >
                4
              </button>
              <button
                @click="filterPriority = 5; filterTasks();"
                :class="{'active-filter': filterPriority === 5}"
                class="p-3 border rounded"
              >
                5
              </button>
            </div>
          </div>
          <template
            x-for="(section, sectionIndex) in sections"
            :key="sectionIndex"
          >
            <template x-if="section.tasks.length">
              <div class="p-3">
                <div class="flex pb-5">
                  <h2
                    x-text="section.title"
                    class="font-bold text-xl dark:text-white"
                  ></h2>
                </div>
                <!-- <div x-html="renderMarkdown(section.content)"></div> -->
                <div class="flex gap-6 flex-col">
                  <template
                    x-for="(task, taskIndex) in section.tasks"
                    :key="sectionIndex + '-' + taskIndex"
                  >
                    <div
                      :class="'task priority-' + task.priority"
                      class="flex flex-col dark:dark:bg-gray-900 border dark:border-gray-800 p-2 rounded-xl shadow-md dark:shadow-black/70"
                    >
                      <div class="flex items-start pb-2">
                        <div
                          class="flex dark:bg-gray-800 rounded-full px-2 py-2 gap-3"
                        >
                          <span
                            :class="taskClass(task.priority)"
                            class="text-white flex justify-center items-center rounded-full text-center px-2"
                            x-text="task.priority"
                          ></span>
                          <span
                            class="text-white flex justify-center items-center text-center pr-2"
                            x-text="task.status"
                          ></span>
                        </div>
                        <div class="pt-2 pl-2">
                          <div
                            class="dark:text-white"
                            x-html="renderMarkdown(task.content)"
                          ></div>
                        </div>
                      </div>

                      <div class="flex flex-col gap-3">
                        <div class="flex flex-col">
                          <label
                            for="countries"
                            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                            >Status</label
                          >
                          <select
                            x-model="task.status"
                            @change="saveToLocalStorage()"
                            id="status"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                          >
                            <option value="">Select status</option>
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                          </select>
                        </div>
                        <div class="flex flex-col">
                          <label
                            for="message"
                            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                            >Notes:</label
                          >
                          <textarea
                            x-model="task.notes"
                            :id="'editor-' + sectionIndex + '-' + taskIndex"
                            x-ref="'editor-' + sectionIndex + '-' + taskIndex"
                            @click="initializeEditor($event, sectionIndex, taskIndex)"
                            id="notes"
                            rows="4"
                            class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                            placeholder="Leave a comment..."
                          ></textarea>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </template>
        </div>
      </template>
    </div>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css"
    />
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

    <script>
      function taskViewer() {
        return {
          sections: [],
          filteredSections: [],
          filterStatus: "",
          filterPriority: "",
          loaded: false,
          error: "",
          activeEditor: null,

          init() {
            console.log("Fetching tasks...");
            const storedData = localStorage.getItem("tasks");
            if (storedData) {
              this.sections = JSON.parse(storedData);
              this.filterTasks(); // Apply filters
              this.loaded = true;
            } else {
              fetch("tasks.json")
                .then((response) => {
                  if (!response.ok) {
                    throw new Error(
                      "Network response was not ok: " + response.statusText
                    );
                  }
                  return response.json();
                })
                .then((data) => {
                  this.sections = data;
                  this.saveToLocalStorage();
                  this.filterTasks(); // Apply filters
                  this.loaded = true;
                })
                .catch((error) => {
                  console.error("Failed to load tasks:", error);
                  this.error = "Failed to load tasks: " + error.message;
                });
            }

            // Register a global click event listener
            document.addEventListener(
              "click",
              this.handleClickOutside.bind(this)
            );
          },
          saveToLocalStorage() {
            localStorage.setItem("tasks", JSON.stringify(this.sections));
          },
          renderMarkdown(content) {
            return marked.parse(content);
          },

          initializeEditor(event, sectionIndex, taskIndex) {
            const element = event.target;
            const task = this.sections[sectionIndex].tasks[taskIndex];
            console.log("Task:", task);

            // Check if the editor is already initialized
            if (!element.simplemde) {
              const simplemde = new SimpleMDE({ element });
              element.simplemde = simplemde; // Store the editor instance in the element
              simplemde.value(task.notes);
              simplemde.codemirror.on("change", () => {
                task.notes = simplemde.value();
                this.saveToLocalStorage();
              });
            }
            this.activeEditor = element;
          },

          handleClickOutside(event) {
            console.log(event);
            console.log(this.activeEditor);
            // Check if the click target is outside the active editor
            if (
              this.activeEditor &&
              !this.activeEditor.contains(event.target)
            ) {
              this.destroyEditor(this.activeEditor);
              this.activeEditor = null;
            }
          },
          destroyEditor(element) {
            if (element && element.simplemde) {
              console.log("Destroying editor");
              element.simplemde.toTextArea();
              element.simplemde = null;
            }
          },

          filterTasks() {
            this.filteredSections = this.sections.map((section) => {
              const filteredTasks = section.tasks.filter((task) => {
                const statusMatch =
                  this.filterStatus === "" || task.status === this.filterStatus;
                const priorityMatch =
                  this.filterPriority === "" ||
                  task.priority === this.filterPriority;
                return statusMatch && priorityMatch;
              });
              return { ...section, tasks: filteredTasks };
            });
          },

          downloadTasks() {
            const dataStr = JSON.stringify(this.sections, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "tasks.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          },

          initDarkMode() {
            // Check for saved preference in local storage
            const darkModePreference = localStorage.getItem("darkMode");
            if (darkModePreference) {
              this.darkMode = darkModePreference === "true";
            } else {
              // If no preference, check the system theme
              this.darkMode =
                window.matchMedia &&
                window.matchMedia("(prefers-color-scheme: dark)").matches;
            }
            this.applyDarkMode();
          },
          toggleDarkMode() {
            this.darkMode = !this.darkMode;
            this.applyDarkMode();
            localStorage.setItem("darkMode", this.darkMode);
          },
          applyDarkMode() {
            if (this.darkMode) {
              document.documentElement.classList.add("dark");
            } else {
              document.documentElement.classList.remove("dark");
            }
          },
          taskClass(priority) {
            switch (priority) {
              case 0:
                return "bg-red-500";
              case 1:
                return "bg-orange-500";
              case 2:
                return "bg-yellow-500";
              case 3:
                return "bg-green-500";
              case 4:
                return "bg-blue-500";
              case 5:
                return "bg-gray-500";
              default:
                return "bg-gray-500";
            }
          },
        };
      }
    </script>
    <script>
      // Add 'dark' class to the HTML element if dark mode is enabled
      if (
        localStorage.getItem("darkMode") === "true" ||
        (!localStorage.getItem("darkMode") &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      }
    </script>
  </body>
</html>
